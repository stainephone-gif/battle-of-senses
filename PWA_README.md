# Battle of Senses - Progressive Web App (PWA)

## Что такое PWA?

Progressive Web App (PWA) - это современная веб-технология, которая позволяет веб-приложению работать как нативное мобильное приложение. Battle of Senses теперь поддерживает PWA, что означает:

- Установка на домашний экран (iOS/Android)
- Работа в офлайн-режиме
- Быстрая загрузка благодаря кешированию
- Полноэкранный режим без адресной строки браузера
- Push-уведомления (опционально, в будущем)

## Что было добавлено

### 1. Файлы PWA

```
battle-of-senses/
├── manifest.json              # Манифест PWA (метаданные приложения)
├── service-worker.js          # Service Worker (кеширование и офлайн-режим)
└── icons/                     # Иконки приложения
    ├── icon.svg              # SVG иконка (placeholder)
    ├── generate-icons.sh     # Скрипт генерации PNG иконок
    └── README.md             # Инструкции по созданию иконок
```

### 2. Обновленные HTML файлы

Все 6 HTML файлов обновлены для поддержки PWA:
- `index.html` - главная страница
- `headphones.html` - проверка наушников
- `sluh.html` - аудиальная ветвь
- `quiet.html` - медитация
- `zrenie_mob.html` - визуальная ветвь
- `sound-exhibition.html` - звуковая выставка

**Добавлено в каждый файл:**
- Ссылка на `manifest.json`
- Meta-теги для iOS (Apple Mobile Web App)
- Ссылки на иконки
- Регистрация Service Worker

## Как установить PWA на устройство

### На Android (Chrome/Samsung Internet)

1. Откройте приложение в браузере Chrome
2. Нажмите на меню (три точки) в правом верхнем углу
3. Выберите **"Установить приложение"** или **"Добавить на главный экран"**
4. Подтвердите установку
5. Иконка появится на главном экране

### На iOS (Safari)

1. Откройте приложение в Safari
2. Нажмите кнопку **"Поделиться"** (квадрат со стрелкой вверх)
3. Прокрутите вниз и выберите **"На экран Домой"**
4. Введите название (по умолчанию "Battle of Senses")
5. Нажмите **"Добавить"**
6. Иконка появится на главном экране

### На Desktop (Chrome/Edge)

1. Откройте приложение в браузере
2. Найдите значок установки (⊕) в адресной строке
3. Нажмите **"Установить"**
4. Приложение откроется в отдельном окне

## Офлайн-режим

Service Worker кеширует все необходимые файлы при первом посещении:

**Кешируется:**
- Все HTML страницы
- Изображения из папки `/pic`
- Манифест
- Шрифты Google Fonts (при загрузке)

**НЕ кешируется:**
- API запросы к Philips Hue
- API запросы к Tuya
- Внешние ресурсы (кроме шрифтов)

### Стратегия кеширования

- **Cache First** - для локальных ресурсов (HTML, изображения)
- **Network First** - для внешних API
- **Stale While Revalidate** - для шрифтов

## Особенности и ограничения

### ✅ Что работает в PWA

- Web Audio API (генерация звуков)
- Media Devices API (обнаружение наушников)
- Screen Orientation API (переворот экрана)
- Crypto API (HMAC для Tuya)
- LocalStorage (сохранение настроек освещения)
- Vibration API (тактильная обратная связь)

### ⚠️ Ограничения на iOS

1. **Philips Hue локальная сеть:**
   - Safari ограничивает доступ к локальной сети
   - Может потребоваться установка через Capacitor для нативного доступа

2. **Screen Orientation Lock:**
   - iOS не поддерживает программную блокировку ориентации
   - Детектирование ориентации работает нормально

3. **Vibration API:**
   - Частично поддерживается
   - Может не работать на всех моделях iPhone

4. **Autoplay звука:**
   - Требуется взаимодействие пользователя
   - Уже реализовано через Intersection Observer + клики

### ✅ Что работает на Android

Все функции работают полностью:
- Philips Hue через локальную сеть
- Tuya API через HTTPS
- Screen Orientation Lock
- Vibration API
- Autoplay (с ограничениями Chrome)

## Обновление PWA

### Автоматическое обновление

Service Worker проверяет обновления каждые 60 секунд (только на главной странице `index.html`). При обнаружении новой версии:

1. Загружаются новые файлы в фоновом режиме
2. Страница автоматически перезагружается
3. Пользователь видит обновленную версию

### Ручное обновление кеша

**Способ 1: Очистка кеша в DevTools (для разработки)**

1. Откройте Chrome DevTools (F12)
2. Перейдите на вкладку **Application**
3. В разделе **Storage** нажмите **Clear site data**
4. Обновите страницу (Ctrl+Shift+R)

**Способ 2: Изменение версии в `service-worker.js`**

```javascript
const CACHE_NAME = 'battle-of-senses-v1.0.1'; // Измените версию
```

После изменения версии старые кеши будут автоматически удалены.

## Настройка манифеста

Файл `manifest.json` содержит метаданные приложения:

```json
{
  "name": "Battle of Senses - Битва Чувств",
  "short_name": "Battle of Senses",
  "start_url": "/index.html",
  "display": "standalone",
  "background_color": "#000000",
  "theme_color": "#000000"
}
```

### Основные параметры

- **name** - полное название (отображается при установке)
- **short_name** - короткое название (под иконкой)
- **start_url** - начальная страница при запуске
- **display** - режим отображения:
  - `standalone` - полноэкранный без браузерного UI (текущий)
  - `fullscreen` - полный экран
  - `minimal-ui` - минимальный UI
  - `browser` - обычный браузер
- **orientation** - ориентация экрана:
  - `any` - любая (текущий)
  - `portrait` - только портрет
  - `landscape` - только альбомная

### Shortcuts (быстрые действия)

Манифест поддерживает быстрые действия:

```json
"shortcuts": [
  {
    "name": "Путь Слуха",
    "url": "/headphones.html?path=audio"
  },
  {
    "name": "Путь Зрения",
    "url": "/zrenie_mob.html"
  }
]
```

**Android:** Долгое нажатие на иконку → быстрые действия
**iOS:** Не поддерживается (пока)

## Создание иконок

⚠️ **ВАЖНО:** Пока используется SVG placeholder иконка!

### Для продакшена необходимо создать PNG иконки:

1. Перейдите в папку `/icons`
2. Прочитайте `icons/README.md`
3. Используйте один из предложенных методов:
   - Онлайн-генератор: https://www.pwabuilder.com/imageGenerator
   - Скрипт `generate-icons.sh` (требует ImageMagick)
   - Вручную в графическом редакторе

### Требуемые размеры

- 72x72, 96x96, 128x128, 144x144, 152x152
- **192x192** (обязательно для Android)
- 384x384
- **512x512** (обязательно для splash screen)

## Тестирование PWA

### Chrome DevTools

1. Откройте приложение в Chrome
2. F12 → вкладка **Application**
3. Проверьте:
   - **Manifest** - корректность данных
   - **Service Workers** - статус регистрации
   - **Cache Storage** - кешированные файлы
4. Запустите **Lighthouse** аудит:
   - F12 → вкладка **Lighthouse**
   - Выберите категорию **Progressive Web App**
   - Нажмите **Generate report**
   - Цель: 90+ баллов

### Мобильное тестирование

**Android:**
```
chrome://inspect/#devices
```
Подключите телефон через USB и инспектируйте PWA

**iOS:**
Safari → Preferences → Advanced → Show Develop menu
Develop → [Ваш iPhone] → [Страница PWA]

## Деплой PWA

### Требования к хостингу

1. **HTTPS обязателен!**
   - Service Worker работает только через HTTPS
   - Исключение: `localhost` для разработки

2. **Правильные MIME-типы:**
   ```
   manifest.json → application/manifest+json
   service-worker.js → application/javascript
   ```

3. **Кеширование на сервере:**
   - Service Worker и Manifest НЕ должны кешироваться
   ```
   Cache-Control: no-cache
   ```

### Рекомендуемые хостинги

- **GitHub Pages** (бесплатно, HTTPS автоматически)
- **Netlify** (бесплатно, автоматический HTTPS)
- **Vercel** (бесплатно, Edge Network)
- **Firebase Hosting** (бесплатно, CDN)

### Пример деплоя на GitHub Pages

```bash
# Создайте ветку gh-pages
git checkout -b gh-pages

# Запушьте изменения
git push origin gh-pages

# Настройте GitHub Pages в Settings → Pages
# Source: gh-pages branch
```

После деплоя приложение будет доступно:
```
https://username.github.io/battle-of-senses/
```

## Troubleshooting

### Service Worker не регистрируется

**Проблема:** Ошибка в консоли `Failed to register service worker`

**Решения:**
1. Проверьте HTTPS (или localhost)
2. Проверьте путь к `service-worker.js` (должен быть в корне)
3. Откройте DevTools → Application → Service Workers → Unregister
4. Обновите страницу

### Иконки не отображаются

**Проблема:** При установке отображается дефолтная иконка

**Решения:**
1. Создайте PNG иконки (см. `/icons/README.md`)
2. Проверьте пути в `manifest.json`
3. Проверьте MIME-типы: `image/png`
4. Очистите кеш браузера

### Офлайн-режим не работает

**Проблема:** Приложение не загружается без интернета

**Решения:**
1. Проверьте регистрацию Service Worker в DevTools
2. Проверьте Cache Storage → `battle-of-senses-v1.0.0`
3. Убедитесь, что файлы закешированы
4. Попробуйте обновить версию в `service-worker.js`

### Приложение не обновляется

**Проблема:** Старая версия продолжает отображаться

**Решения:**
1. Увеличьте версию в `service-worker.js`:
   ```javascript
   const CACHE_NAME = 'battle-of-senses-v1.0.1';
   ```
2. Жесткая перезагрузка: Ctrl+Shift+R
3. Unregister Service Worker в DevTools
4. Очистите кеш браузера

## Дальнейшее развитие

### Что можно добавить

1. **Push-уведомления**
   - Напоминания о новых экспонатах
   - Уведомления о событиях

2. **Background Sync**
   - Синхронизация настроек освещения
   - Офлайн-сохранение прогресса

3. **Share API**
   - Кнопка "Поделиться опытом"
   - Отправка скриншотов друзьям

4. **Install Prompt**
   - Кастомная кнопка "Установить приложение"
   - Показ при повторном посещении

5. **Web Share Target**
   - Прием медиа-файлов из других приложений
   - Интеграция с системой шаринга

### Миграция на Capacitor (опционально)

Для полного нативного опыта можно использовать Capacitor:

```bash
npm install @capacitor/core @capacitor/cli
npx cap init
npx cap add ios
npx cap add android
```

Преимущества:
- Публикация в App Store и Google Play
- Доступ к нативным API устройства
- Лучшая интеграция с Philips Hue (локальная сеть)
- Полная поддержка всех возможностей устройства

## Поддержка

При возникновении проблем:

1. Проверьте консоль браузера (F12)
2. Посмотрите `Application → Service Workers` в DevTools
3. Запустите Lighthouse аудит
4. Создайте issue в репозитории

## Лицензия

Этот PWA функционал добавлен к проекту Battle of Senses и распространяется под той же лицензией.

---

**Версия PWA:** 1.0.0
**Дата обновления:** 2025-11-21
**Совместимость:** Chrome 90+, Safari 14+, Firefox 88+, Edge 90+
