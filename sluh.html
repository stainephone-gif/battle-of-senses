<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–°–ª—É—Ö ‚Äî –∞—É–¥–∏–∞–ª—å–Ω–∞—è –≤–µ—Ç–≤—å</title>

  <!-- PWA Android Bridge -->
  <script src="./pwa-android-bridge.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="icon" type="image/svg+xml" href="./icons/icon.svg">

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      margin: 0;
      display: flex;
      justify-content: center;
      background: #000;
      font-family: 'Courier New', monospace;
      overflow-x: hidden;
      color: #fff;
    }

    .phone-frame {
      width: 100%;
      max-width: 428px;
      background: #000;
      overflow-x: hidden;
      position: relative;
    }

    section {
      position: relative;
      min-height: 100vh;
      min-height: calc(var(--vh, 1vh) * 100);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      text-align: center;
      background: #000;
      border-top: 1px solid #333;
    }

    h2 {
      font-size: 1.4rem;
      margin: 0 0 40px;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity 1s ease, transform 1s ease;
      z-index: 10;
      position: relative;
      font-weight: 300;
      letter-spacing: 3px;
      color: #fff;
      text-transform: uppercase;
    }

    h2.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä */
    .progress-container {
      width: 100%;
      max-width: 300px;
      height: 4px;
      background: #222;
      margin: 20px auto;
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar {
      height: 100%;
      width: 0%;
      background: #fff;
      transition: width 0.3s ease;
    }

    /* –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ */
    .sound-visualizer {
      width: 100%;
      max-width: 350px;
      height: 200px;
      margin: 30px auto;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
    }

    .bar {
      width: 4px;
      background: #fff;
      border-radius: 2px;
      transition: height 0.1s ease;
      opacity: 0.7;
    }

    /* –¢–µ–∫—Å—Ç–æ–≤—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã */
    .audio-text {
      font-size: 0.9rem;
      line-height: 1.6rem;
      margin: 20px auto;
      max-width: 320px;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.8s ease, transform 0.8s ease;
      color: #aaa;
    }

    .audio-text.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */
    .controls {
      display: flex;
      gap: 20px;
      margin: 30px auto;
      justify-content: center;
      align-items: center;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #fff;
      color: #000;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: all 0.3s ease;
      user-select: none;
    }

    .control-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(255,255,255,0.5);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn.secondary {
      width: 44px;
      height: 44px;
      background: transparent;
      color: #fff;
      font-size: 1.2rem;
    }

    /* –°—Ç—Ä–µ–ª–∫–∞ –≤–Ω–∏–∑ */
    .arrow {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 2rem;
      color: rgba(255,255,255,0.6);
      text-decoration: none;
      animation: bounce 2s infinite;
      z-index: 10;
      transition: color 0.3s ease;
    }

    .arrow:hover {
      color: rgba(255,255,255,0.9);
    }

    @keyframes bounce {
      0%, 100% { transform: translate(-50%, 0); }
      50% { transform: translate(-50%, 15px); }
    }

    /* –ö–Ω–æ–ø–∫–∞ —Ñ–∏–Ω–∏—à–∞ */
    .finish-btn {
      display: inline-block;
      margin-top: 40px;
      padding: 16px 40px;
      background: #fff;
      color: #000;
      text-decoration: none;
      border-radius: 30px;
      font-weight: 600;
      font-size: 1rem;
      box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 10;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    .finish-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 255, 255, 0.5);
    }

    .finish-btn:active {
      transform: translateY(0);
    }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
    .nav-home {
      position: fixed;
      top: 20px;
      left: 20px;
      width: 44px;
      height: 44px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      color: #fff;
      font-size: 1.2rem;
      z-index: 1000;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .nav-home:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: scale(1.1);
    }

    /* –ì–ª–∏—Ç—á-—ç—Ñ—Ñ–µ–∫—Ç—ã –¥–ª—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞—Ä–∞—Å—Ç–∞—é—â–∏–µ */
    #stage1 h2 {
      animation: none;
    }

    #stage2 h2 {
      animation: text-glitch-1 3s ease-in-out infinite;
    }

    #stage3 h2 {
      animation: text-glitch-2 2s ease-in-out infinite;
    }

    #stage4 h2 {
      animation: text-glitch-3 1.5s ease-in-out infinite;
    }

    #stage5 h2 {
      animation: text-glitch-4 1s ease-in-out infinite;
    }

    @keyframes text-glitch-1 {
      0%, 100% { opacity: 1; transform: translateY(0); }
      50% { opacity: 0.9; transform: translateY(1px); }
    }

    @keyframes text-glitch-2 {
      0%, 100% { opacity: 1; transform: translateY(0) translateX(0); }
      25% { opacity: 0.8; transform: translateY(-1px) translateX(1px); }
      75% { opacity: 0.9; transform: translateY(1px) translateX(-1px); }
    }

    @keyframes text-glitch-3 {
      0%, 100% { opacity: 1; transform: translateY(0) translateX(0); }
      20% { opacity: 0.7; transform: translateY(-2px) translateX(2px); }
      40% { opacity: 0.9; transform: translateY(1px) translateX(-1px); }
      60% { opacity: 0.8; transform: translateY(2px) translateX(-2px); }
    }

    @keyframes text-glitch-4 {
      0%, 100% { opacity: 1; transform: translateY(0) translateX(0); letter-spacing: 3px; }
      10% { opacity: 0.5; transform: translateY(-3px) translateX(3px); letter-spacing: 5px; }
      25% { opacity: 0.8; transform: translateY(2px) translateX(-2px); letter-spacing: 1px; }
      40% { opacity: 0.6; transform: translateY(-2px) translateX(2px); letter-spacing: 4px; }
      60% { opacity: 0.9; transform: translateY(3px) translateX(-3px); letter-spacing: 2px; }
      80% { opacity: 0.7; transform: translateY(-1px) translateX(1px); letter-spacing: 6px; }
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —É—Ä–æ–≤–Ω—è –∑–≤—É–∫–∞ */
    .volume-indicator {
      font-size: 0.8rem;
      color: #666;
      margin-top: 10px;
      letter-spacing: 1px;
    }

    /* –ò–∫–æ–Ω–∫–∞ —Å–≤–∞–π–ø–∞ */
    .swipe-hint {
      margin-top: 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
      opacity: 0;
      animation: fadeInSwipe 2s ease-in-out 1s forwards;
    }

    @keyframes fadeInSwipe {
      to {
        opacity: 1;
      }
    }

    .swipe-icon {
      animation: swipeLeftAnim 2s ease-in-out infinite;
    }

    @keyframes swipeLeftAnim {
      0%, 100% {
        transform: translateX(0);
        opacity: 1;
      }
      50% {
        transform: translateX(-15px);
        opacity: 0.6;
      }
    }

    .swipe-text {
      font-size: 0.9rem;
      color: #aaa;
      letter-spacing: 1px;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∞–Ω–∏–º–∞—Ü–∏–π */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="phone-frame">
    <!-- –ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π" -->
    <a href="main.html" class="nav-home" id="homeBtn" aria-label="–ù–∞ –≥–ª–∞–≤–Ω—É—é">‚åÇ</a>

    <!-- –≠—Ç–∞–ø 1 -->
    <section id="stage1" data-stage="1">
      <h2>–ù–∞—á–∞–ª–æ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏—è</h2>
      <div class="audio-text">
        –§–∏–ª–æ—Å–æ—Ñ—ã –¥—Ä–µ–≤–Ω–æ—Å—Ç–∏ —Å—á–∏—Ç–∞–ª–∏ —Å–ª—É—Ö –ø—Ä–æ–≤–æ–¥–Ω–∏–∫–æ–º –∑–Ω–∞–Ω–∏—è. –ê—Ä–∏—Å—Ç–æ—Ç–µ–ª—å –ø–∏—Å–∞–ª: ¬´–°–ª—É—Ö –±–æ–ª–µ–µ –¥—Ä—É–≥–∏—Ö —á—É–≤—Å—Ç–≤ —Å–ø–æ—Å–æ–±—Å—Ç–≤—É–µ—Ç —Ä–∞–∑–≤–∏—Ç–∏—é —Ä–∞–∑—É–º–∞¬ª.
      </div>
      <div class="sound-visualizer" id="visualizer1"></div>
      <div class="controls">
        <button class="control-btn secondary" onclick="audioManager.stop(1)">‚èπ</button>
        <button class="control-btn" onclick="audioManager.play(1)">‚ñ∂</button>
        <button class="control-btn secondary" onclick="audioManager.stop(1)">‚è∏</button>
      </div>
      <div class="volume-indicator">–£—Ä–æ–≤–µ–Ω—å: <span id="level1">–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π</span></div>
      <a class="arrow" href="#stage2" aria-label="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø">‚åÑ</a>
    </section>

    <!-- –≠—Ç–∞–ø 2 -->
    <section id="stage2" data-stage="2">
      <h2>–ó–≤—É–∫–∏ –º–Ω–æ–∂–∞—Ç—Å—è</h2>
      <div class="audio-text">
        –í –°—Ä–µ–¥–Ω–µ–≤–µ–∫–æ–≤—å–µ –º–æ–Ω–∞—Ö–∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–ª–∏ –≤–ª–∏—è–Ω–∏–µ –≥—Ä–∏–≥–æ—Ä–∏–∞–Ω—Å–∫–∏—Ö —Ö–æ—Ä–∞–ª–æ–≤ –Ω–∞ —Å–æ–∑–Ω–∞–Ω–∏–µ, –æ—Ç–∫—Ä—ã–≤–∞—è –Ω–æ–≤—ã–µ –≥—Ä–∞–Ω–∏ —Å–ª—É—Ö–æ–≤–æ–≥–æ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è.
      </div>
      <div class="sound-visualizer" id="visualizer2"></div>
      <div class="controls">
        <button class="control-btn secondary" onclick="audioManager.stop(2)">‚èπ</button>
        <button class="control-btn" onclick="audioManager.play(2)">‚ñ∂</button>
        <button class="control-btn secondary" onclick="audioManager.stop(2)">‚è∏</button>
      </div>
      <div class="volume-indicator">–£—Ä–æ–≤–µ–Ω—å: <span id="level2">—Å—Ä–µ–¥–Ω–∏–π</span></div>
      <a class="arrow" href="#stage3" aria-label="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø">‚åÑ</a>
    </section>

    <!-- –≠—Ç–∞–ø 3 -->
    <section id="stage3" data-stage="3">
      <h2>–ù–∞—Ä–∞—Å—Ç–∞–Ω–∏–µ —Ö–∞–æ—Å–∞</h2>
      <div class="audio-text">
        –ù–µ–º–µ—Ü–∫–∏–µ —Ñ–∏–ª–æ—Å–æ—Ñ—ã –≥–æ–≤–æ—Ä–∏–ª–∏ –æ –º—É–∑—ã–∫–µ –∫–∞–∫ –æ –≤—ã—Å—à–µ–π —Ñ–æ—Ä–º–µ –∏—Å–∫—É—Å—Å—Ç–≤–∞. –®–æ–ø–µ–Ω–≥–∞—É—ç—Ä —Å—á–∏—Ç–∞–ª –µ—ë –ø—Ä—è–º—ã–º –≤—ã—Ä–∞–∂–µ–Ω–∏–µ–º –≤–æ–ª–∏.
      </div>
      <div class="sound-visualizer" id="visualizer3"></div>
      <div class="controls">
        <button class="control-btn secondary" onclick="audioManager.stop(3)">‚èπ</button>
        <button class="control-btn" onclick="audioManager.play(3)">‚ñ∂</button>
        <button class="control-btn secondary" onclick="audioManager.stop(3)">‚è∏</button>
      </div>
      <div class="volume-indicator">–£—Ä–æ–≤–µ–Ω—å: <span id="level3">–≤—ã—Å–æ–∫–∏–π</span></div>
      <a class="arrow" href="#stage4" aria-label="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø">‚åÑ</a>
    </section>

    <!-- –≠—Ç–∞–ø 4 -->
    <section id="stage4" data-stage="4">
      <h2>–ò—Å–∫–∞–∂–µ–Ω–∏–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è</h2>
      <div class="audio-text">
        –•–• –≤–µ–∫ –ø—Ä–∏–Ω—ë—Å —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã —Å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω–æ–π –º—É–∑—ã–∫–æ–π –∏ –∑–≤—É–∫–æ–≤—ã–º–∏ –∫–æ–ª–ª–∞–∂–∞–º–∏, —Ä–∞—Å—à–∏—Ä—è—è –≥—Ä–∞–Ω–∏—Ü—ã —Å–ª—É—Ö–æ–≤–æ–≥–æ –æ–ø—ã—Ç–∞.
      </div>
      <div class="sound-visualizer" id="visualizer4"></div>
      <div class="controls">
        <button class="control-btn secondary" onclick="audioManager.stop(4)">‚èπ</button>
        <button class="control-btn" onclick="audioManager.play(4)">‚ñ∂</button>
        <button class="control-btn secondary" onclick="audioManager.stop(4)">‚è∏</button>
      </div>
      <div class="volume-indicator">–£—Ä–æ–≤–µ–Ω—å: <span id="level4">–æ—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π</span></div>
      <a class="arrow" href="#stage5" aria-label="–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø">‚åÑ</a>
    </section>

    <!-- –≠—Ç–∞–ø 5 -->
    <section id="stage5" data-stage="5">
      <h2>–ö–∞–∫–æ—Ñ–æ–Ω–∏—è</h2>
      <div class="audio-text">
        –ù–µ–π—Ä–æ–Ω–∞—É–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, –∫–∞–∫ –º–æ–∑–≥ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∑–≤—É–∫–æ–≤—ã–µ –≤–æ–ª–Ω—ã, –ø—Ä–µ–≤—Ä–∞—â–∞—è –∏—Ö –≤ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã. –ù–æ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç, –∫–æ–≥–¥–∞ –∑–≤—É–∫–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ?
      </div>
      <div class="sound-visualizer" id="visualizer5"></div>
      <div class="controls">
        <button class="control-btn secondary" onclick="audioManager.stop(5)">‚èπ</button>
        <button class="control-btn" onclick="audioManager.play(5)">‚ñ∂</button>
        <button class="control-btn secondary" onclick="audioManager.stop(5)">‚è∏</button>
      </div>
      <div class="volume-indicator">–£—Ä–æ–≤–µ–Ω—å: <span id="level5">–º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π</span></div>

      <!-- –ò–∫–æ–Ω–∫–∞ —Å–≤–∞–π–ø–∞ –≤–ª–µ–≤–æ -->
      <div class="swipe-hint" id="swipeHint">
        <div class="swipe-icon">
          <svg width="80" height="60" viewBox="0 0 80 60" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- –†—É–∫–∞ -->
            <path d="M55 25 Q50 20 45 25 L35 35 Q30 40 35 45 Q40 50 45 45 L55 35 Q60 30 55 25"
                  fill="#ffffff" opacity="0.8"/>
            <!-- –°—Ç—Ä–µ–ª–∫–∞ –≤–ª–µ–≤–æ -->
            <path d="M35 30 L15 30" stroke="#ffffff" stroke-width="3" stroke-linecap="round"/>
            <path d="M22 23 L15 30 L22 37" stroke="#ffffff" stroke-width="3" stroke-linecap="round"
                  stroke-linejoin="round" fill="none"/>
            <!-- –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞—è —Ç—Ä–∞–µ–∫—Ç–æ—Ä–∏—è -->
            <path d="M60 30 L40 30" stroke="#ffffff" stroke-width="2" stroke-dasharray="4,4"
                  opacity="0.5" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="swipe-text">–°–≤–∞–π–ø–Ω–∏—Ç–µ –≤–ª–µ–≤–æ</div>
      </div>
    </section>
  </div>

  <script>
    // ================================================
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï VIEWPORT –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• –£–°–¢–†–û–ô–°–¢–í
    // ================================================
    function setViewportHeight() {
      const vh = window.innerHeight * 0.01;
      document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    setViewportHeight();
    window.addEventListener('resize', setViewportHeight);
    window.addEventListener('orientationchange', () => {
      setTimeout(setViewportHeight, 100);
    });

    // –ú–µ–Ω–µ–¥–∂–µ—Ä –∞—É–¥–∏–æ —Å Web Audio API
    const audioManager = {
      context: null,
      oscillators: {},
      gainNodes: {},

      init() {
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è AudioContext –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
        if (!this.context) {
          this.context = new (window.AudioContext || window.webkitAudioContext)();
        }
      },

      play(stage) {
        this.init();

        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–≤—É–∫ –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞
        this.stop(stage);

        // –°–æ–∑–¥–∞–µ–º –æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä –∏ gain node
        const oscillator = this.context.createOscillator();
        const gainNode = this.context.createGain();

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
        const configs = {
          1: { freq: 220, type: 'sine', gain: 0.1, detune: 0 },
          2: { freq: 330, type: 'triangle', gain: 0.15, detune: 10 },
          3: { freq: 440, type: 'square', gain: 0.2, detune: 20 },
          4: { freq: 550, type: 'sawtooth', gain: 0.25, detune: 30 },
          5: { freq: 660, type: 'square', gain: 0.3, detune: 50 }
        };

        const config = configs[stage];
        oscillator.type = config.type;
        oscillator.frequency.setValueAtTime(config.freq, this.context.currentTime);
        oscillator.detune.setValueAtTime(config.detune, this.context.currentTime);

        gainNode.gain.setValueAtTime(0, this.context.currentTime);
        gainNode.gain.linearRampToValueAtTime(config.gain, this.context.currentTime + 0.5);

        oscillator.connect(gainNode);
        gainNode.connect(this.context.destination);

        oscillator.start();

        this.oscillators[stage] = oscillator;
        this.gainNodes[stage] = gainNode;

        // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è
        this.visualize(stage);
      },

      stop(stage) {
        if (this.oscillators[stage]) {
          const gainNode = this.gainNodes[stage];
          gainNode.gain.linearRampToValueAtTime(0, this.context.currentTime + 0.3);

          setTimeout(() => {
            if (this.oscillators[stage]) {
              this.oscillators[stage].stop();
              delete this.oscillators[stage];
              delete this.gainNodes[stage];
            }
          }, 300);
        }
      },

      visualize(stage) {
        const visualizer = document.getElementById(`visualizer${stage}`);
        if (!visualizer) return;

        // –°–æ–∑–¥–∞–µ–º —Å—Ç–æ–ª–±—Ü—ã –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
        visualizer.innerHTML = '';
        const barCount = 40;

        for (let i = 0; i < barCount; i++) {
          const bar = document.createElement('div');
          bar.className = 'bar';
          const baseHeight = 20;
          const randomHeight = Math.random() * (stage * 20);
          bar.style.height = (baseHeight + randomHeight) + 'px';
          visualizer.appendChild(bar);
        }

        // –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç–æ–ª–±—Ü–æ–≤
        let frameCount = 0;
        const animate = () => {
          if (!this.oscillators[stage]) return;

          const bars = visualizer.querySelectorAll('.bar');
          bars.forEach((bar, i) => {
            const baseHeight = 20;
            const randomHeight = Math.random() * (stage * 20);
            const wave = Math.sin(frameCount * 0.1 + i * 0.3) * (stage * 5);
            bar.style.height = (baseHeight + randomHeight + wave) + 'px';
          });

          frameCount++;
          requestAnimationFrame(animate);
        };

        animate();
      }
    };

    // Intersection Observer –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤
    const observerOptions = {
      threshold: 0.3,
      rootMargin: '0px 0px -100px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          entry.target.classList.add('visible');

          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–∞—á–∞–ª–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –ø—Ä–∏ –ø–æ—è–≤–ª–µ–Ω–∏–∏ —Å–µ–∫—Ü–∏–∏
          const stage = entry.target.dataset.stage;
          if (stage) {
            setTimeout(() => {
              audioManager.play(parseInt(stage));
            }, 500);
          }
        }
      });
    }, observerOptions);

    // –ù–∞–±–ª—é–¥–∞–µ–º –∑–∞ –≤—Å–µ–º–∏ —ç–ª–µ–º–µ–Ω—Ç–∞–º–∏
    document.querySelectorAll('h2, .audio-text, section').forEach(el => {
      observer.observe(el);
    });

    // –ü–ª–∞–≤–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∑–≤—É–∫–∏ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
      [1, 2, 3, 4, 5].forEach(stage => audioManager.stop(stage));
    });

    // ========== –û–ë–†–ê–ë–û–¢–ö–ê –°–í–ê–ô–ü–ê –í–õ–ï–í–û –ù–ê STAGE5 ==========
    let isOnStage5 = false;
    let swipeDetected = false;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ stage5
    const stage5Observer = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.target.id === 'stage5') {
          isOnStage5 = entry.isIntersecting;
        }
      });
    }, { threshold: 0.5 });

    const stage5 = document.getElementById('stage5');
    if (stage5) {
      stage5Observer.observe(stage5);
    }

    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Å–≤–∞–π–ø–∞
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞—á–∞–ª–∞ –∫–∞—Å–∞–Ω–∏—è
    function handleTouchStart(e) {
      touchStartX = e.changedTouches[0].screenX;
      touchStartY = e.changedTouches[0].screenY;
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–∫–æ–Ω—á–∞–Ω–∏—è –∫–∞—Å–∞–Ω–∏—è
    function handleTouchEnd(e) {
      touchEndX = e.changedTouches[0].screenX;
      touchEndY = e.changedTouches[0].screenY;
      handleSwipe();
    }

    // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–≤–∞–π–ø–∞
    function handleSwipe() {
      if (!isOnStage5 || swipeDetected) return;

      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;

      // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è —Å–≤–∞–π–ø–∞ (50px)
      const minSwipeDistance = 50;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π —Å–≤–∞–π–ø –≤–ª–µ–≤–æ
      if (Math.abs(diffX) > Math.abs(diffY) && diffX > minSwipeDistance) {
        swipeDetected = true;

        // –ü–ª–∞–≤–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ
        document.body.style.transition = 'opacity 0.5s ease';
        document.body.style.opacity = '0';

        setTimeout(() => {
          window.location.href = 'sound-exhibition.html';
        }, 500);
      }
    }

    // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫–∞—Å–∞–Ω–∏—è
    document.addEventListener('touchstart', handleTouchStart, { passive: true });
    document.addEventListener('touchend', handleTouchEnd, { passive: true });

    // PWA: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./service-worker.js')
        .then(reg => console.log('‚úÖ SW registered'))
        .catch(err => console.error('‚ùå SW error:', err));
    }

    // ========== –í–ö–õ–Æ–ß–ï–ù–ò–ï –°–í–ï–¢–ê –ü–†–ò –í–û–ó–í–†–ê–¢–ï –î–û–ú–û–ô ==========

    let lightsConfig = null;

    // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Å–≤–µ—â–µ–Ω–∏—è
    function loadLightsConfig() {
      const saved = localStorage.getItem('lights_config');
      if (saved) {
        try {
          lightsConfig = JSON.parse(saved);
        } catch (e) {
          console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–≤–µ—Ç–∞:', e);
        }
      }
    }

    // –í–∫–ª—é—á–µ–Ω–∏–µ —Å–≤–µ—Ç–∞ (Philips Hue)
    async function turnOnLights() {
      if (!lightsConfig || lightsConfig.type !== 'hue') return;

      try {
        const response = await fetch(`http://${lightsConfig.ip}/api/${lightsConfig.apiKey}/lights`);
        if (!response.ok) return;

        const lights = await response.json();
        const lightIds = Object.keys(lights);

        // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ –ª–∞–º–ø—ã
        for (const id of lightIds) {
          await fetch(`http://${lightsConfig.ip}/api/${lightsConfig.apiKey}/lights/${id}/state`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ on: true, bri: 254 }) // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —è—Ä–∫–æ—Å—Ç—å
          });
        }

        console.log('üí° –°–≤–µ—Ç –≤–∫–ª—é—á–µ–Ω');

        // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
        if (typeof Android !== 'undefined') {
          Android.vibrate(100);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–∫–ª—é—á–µ–Ω–∏—è —Å–≤–µ—Ç–∞:', error);
      }
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    loadLightsConfig();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–æ–º–æ–π" - –≤–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç
    const homeBtn = document.getElementById('homeBtn');
    if (homeBtn) {
      homeBtn.addEventListener('click', async (e) => {
        if (lightsConfig) {
          e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –Ω–µ–º–µ–¥–ª–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥

          console.log('üè† –ö–Ω–æ–ø–∫–∞ "–î–æ–º–æ–π" –Ω–∞–∂–∞—Ç–∞, –≤–∫–ª—é—á–∞–µ–º —Å–≤–µ—Ç...');
          await turnOnLights();

          // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω–∏—è
          setTimeout(() => {
            window.location.href = 'main.html';
          }, 500);
        }
        // –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –ø–æ —Å—Å—ã–ª–∫–µ
      });
    }
  </script>
</body>
</html>
