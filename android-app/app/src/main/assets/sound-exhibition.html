<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Звуковая выставка — карта</title>

<!-- PWA Manifest -->
<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" type="image/svg+xml" href="./icons/icon.svg">

<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  background:#000;
  color:#fff;
  font-family:Arial, Helvetica, sans-serif;
  overflow:hidden;
  cursor:grab;
}
body:active{cursor:grabbing}

#exhibition-space{
  position:absolute;
  width:5000px;
  height:5000px;
  transform-origin:0 0;
  transition:transform .4s ease;
}

.bookmark{
  position:absolute;
  width:40px;
  height:60px;
  cursor:pointer;
  transition:all .25s ease;
  z-index:2;
}
.bookmark.exhibit{
  border-top:40px solid #444;
  border-left:20px solid transparent;
  border-right:20px solid transparent;
  background: linear-gradient(180deg,#222,#111);
  border-radius:4px;
}
.bookmark.exhibit:hover{ transform:scale(1.15) rotate(6deg) }

.bookmark.decoy{
  width:28px;height:48px;
  background:repeating-linear-gradient(45deg,#666,#666 5px,#333 5px,#333 10px);
  transform:rotate(12deg);
  border-radius:3px;
  opacity:.95;
}

.exhibit-panel{
  position:fixed;
  left:50%;
  transform:translateX(-50%);
  bottom:-340px;
  width:92%;
  max-width:680px;
  background:rgba(14,14,14,.96);
  padding:18px;
  border-radius:14px 14px 0 0;
  box-shadow:0 -6px 30px rgba(0,0,0,.6);
  transition:bottom .45s cubic-bezier(.2,.9,.2,1);
  z-index:1000;
}
.exhibit-panel.active{ bottom:0 }

.exhibit-panel h2{ font-size:1.3rem; margin-bottom:8px }
.exhibit-panel p{ opacity:.95; line-height:1.45; margin-bottom:12px }

.audio-controls{ display:flex; align-items:center; gap:10px; margin-top:6px }
.audio-controls button{
  background:#333;border:1px solid #2a2a2a;color:#fff;padding:8px 12px;border-radius:6px;
  cursor:pointer;font-size:14px;
}
.audio-controls progress{ flex:1; height:10px; border-radius:6px; overflow:hidden; cursor:pointer; }

.navigation-info{
  position:fixed; left:18px; top:18px; z-index:1000;
  background:rgba(0,0,0,.6); padding:10px 12px; border-radius:6px; font-size:13px;
}

.home-btn{
  position:fixed; right:18px; top:18px; z-index:1000;
  width:44px;height:44px;border-radius:50%; background:rgba(30,30,30,.85); border:1px solid rgba(255,255,255,.3); color:#fff; font-size:20px; cursor:pointer;
  display:flex; align-items:center; justify-content:center; text-decoration:none;
}

.zoom-controls{
  position:fixed; right:18px; bottom:18px; display:flex; flex-direction:column; gap:8px; z-index:1000;
}
.zoom-controls button{
  width:44px;height:44px;border-radius:50%; background:rgba(30,30,30,.85); border:none; color:#fff; font-size:20px; cursor:pointer;
}
.small-muted{ font-size:12px; opacity:.8; margin-top:6px }
</style>
</head>
<body>
<div id="exhibition-space" aria-hidden="true"></div>

<div class="exhibit-panel" id="exhibit-panel" aria-hidden="true">
  <h2 id="exhibit-title"></h2>
  <p id="exhibit-description"></p>

  <div class="audio-controls">
    <button id="play-btn" title="Воспроизвести/пауза">▶</button>
    <button id="switch-audio" title="Переключить дорожку">Куратор</button>
    <button id="close-btn" title="Закрыть">✕</button>
    <progress id="audio-progress" value="0" max="100"></progress>
  </div>
  <div class="small-muted">Нажмите любую клавишу (вне панели) — проиграется случайный шум.</div>
</div>

<div class="navigation-info">Перетаскивайте карту · Кликните на экспонат</div>

<a href="main.html" class="home-btn" title="На главную">⌂</a>

<div class="zoom-controls">
  <button id="zoom-in" title="Увеличить">+</button>
  <button id="zoom-out" title="Уменьшить">−</button>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const exhibitionSpace = document.getElementById('exhibition-space');
  const exhibitPanel = document.getElementById('exhibit-panel');
  const exhibitTitle = document.getElementById('exhibit-title');
  const exhibitDescription = document.getElementById('exhibit-description');

  const playBtn = document.getElementById('play-btn');
  const closeBtn = document.getElementById('close-btn');
  const audioProgress = document.getElementById('audio-progress');
  const switchBtn = document.getElementById('switch-audio');

  const zoomInBtn = document.getElementById('zoom-in');
  const zoomOutBtn = document.getElementById('zoom-out');

  let currentAudio = null;
  let currentMode = 'artist';
  let posX = 0, posY = 0, scale = 1;
  let isDragging = false, startX = 0, startY = 0, scrollLeft = 0, scrollTop = 0;

  const NOISE_COUNT = 6; // количество шумов

  const exhibits = [
    { id:1, title:"Mood Mirror", description:"Анастасия Кедрина, Мария Киселева, Иван Николаев · Интерактивная инсталляция · 2025", audio_artist:"interviews/1.mp3", audio_curator:"interviews/1.mp3", x:500, y:700 },
    { id:2, title:"Гаджеты будущего", description:"Максимилиан Роганов · Генеративная графика · 2025", audio_artist:"interviews/2.mp3", audio_curator:"interviews/2.mp3", x:1400, y:800 },
    { id:3, title:"Set${humans}", description:"Елена Тормышева, Игорь Тормышев, Дмитрий Чуйко · Инсталляция: видеокамера, монитор, ПО с использованием ИИ · 2025", audio_artist:"interviews/3.mp3", audio_curator:"interviews/3.mp3", x:2300, y:900 },
    { id:4, title:"Связь", description:"Екатерина Рыжикова · Холст, акрил, ультрафиолетовые светодиоды, батарейки, переключатель · 2025", audio_artist:"interviews/4.mp3", audio_curator:"interviews/4.mp3", x:3200, y:700 },
    { id:5, title:"Идентификация", description:"Софи Мостовлюк · Веб-сайт · 2024", audio_artist:"interviews/5.mp3", audio_curator:"interviews/5.mp3", x:800, y:1600 },
    { id:6, title:"Трогательно", description:"DIMITRIEV & YANAK · Видео-арт, фотография · 2025", audio_artist:"interviews/6.mp3", audio_curator:"interviews/6.mp3", x:1600, y:1700 },
    { id:7, title:"CAMP", description:"Павел Чекулаев · Двухканальное видео без звука · 2024 · «CAMP — Construction and Assembly Mobile Platform» / Fallout 76", audio_artist:"interviews/7.mp3", audio_curator:"interviews/7.mp3", x:3300, y:1500 },
    { id:8, title:"Tuesday song", description:"z0.sya · Видео-арт · 2024", audio_artist:"interviews/8.mp3", audio_curator:"interviews/8.mp3", x:900, y:2500 },
    { id:9, title:"Свет для одного из нас", description:"Виктор Кертанов · Схемотехника, Unity · 2025", audio_artist:"interviews/9.mp3", audio_curator:"interviews/9.mp3", x:1700, y:2600 },
    { id:10, title:"Дневник искусственного созерцания", description:"Milana Yayo · Net-art · 2024 · Веб-сайт с аудиовизуальными записями", audio_artist:"interviews/10.mp3", audio_curator:"interviews/10.mp3", x:2600, y:2500 },
    { id:11, title:"Soundscape console", description:"Иван Кравчук, Антон Попов · Интерактивная инсталляция · 2025", audio_artist:"interviews/11.mp3", audio_curator:"interviews/11.mp3", x:3500, y:2400 },
    { id:12, title:"Биоконструктор", description:"Азат Галиев · Интерактивная инсталляция · 2025", audio_artist:"interviews/12.mp3", audio_curator:"interviews/12.mp3", x:1100, y:3300 },
    { id:13, title:"ИДИЛЛИЯ", description:"Нина Сибирёва · Интерактивный прототип приложения · 2025", audio_artist:"interviews/13.mp3", audio_curator:"interviews/13.mp3", x:2000, y:3400 },
    { id:14, title:"INVERSE", description:"Саша Пика, Даниил Каркозов, s-lab, Наталия Таренко, Татьяна Маландина · Аудиовизуальная инсталляция · 2025", audio_artist:"interviews/14.mp3", audio_curator:"interviews/14.mp3", x:2900, y:3300 },
    { id:15, title:"Чтение лиц", description:"Марина Грекова · Текстиль с отпечатками, онлайн-приложение по QR-коду · 2025", audio_artist:"interviews/15.mp3", audio_curator:"interviews/15.mp3", x:3800, y:3200 },
    { id:16, title:"Omniharmony", description:"Надежда Бей · VR · 2025", audio_artist:"interviews/16.mp3", audio_curator:"interviews/16.mp3", x:500, y:4200 },
    { id:17, title:"Страшные сказки", description:"Екатерина Козлова · 3D-сканирование, AI · 2024", audio_artist:"interviews/17.mp3", audio_curator:"interviews/17.mp3", x:1400, y:4300 },
    { id:18, title:"Тело города", description:"Елена Деми-дова · Видео · 2025", audio_artist:"interviews/18.mp3", audio_curator:"interviews/18.mp3", x:2500, y:4500 },
    { id:19, title:"Гримаса-синтезатор", description:"Юлия Баранюк · Видеоперформанс, интерактивная инсталляция · 2025", audio_artist:"interviews/19.mp3", audio_curator:"interviews/19.mp3", x:2300, y:4300 },
    { id:20, title:"Пользовательское соглашение любви", description:"Sun Dar, Всеволод Крючков · Веб-сайт · 2025", audio_artist:"interviews/20.mp3", audio_curator:"interviews/20.mp3", x:3200, y:4300 }
  ];

  // Создание экспонатов
  exhibits.forEach(ex => {
    const el = document.createElement('div');
    el.className = 'bookmark exhibit';
    el.style.left = ex.x + 'px';
    el.style.top = ex.y + 'px';
    el.setAttribute('data-id', ex.id);
    el.title = ex.title;
    el.addEventListener('click', e => { e.stopPropagation(); openExhibit(ex); });
    exhibitionSpace.appendChild(el);
  });

  // Создание декой-шумов
  const decoyNoiseList = [
    "interviews/noise1.mp3","interviews/noise2.mp3","interviews/noise3.mp3","interviews/noise4.mp3","interviews/noise5.mp3","interviews/noise6.mp3"
  ];
  for(let i=0;i<25;i++){
    const d = document.createElement('div');
    d.className = 'bookmark decoy';
    d.style.left = Math.random() * 4800 + 'px';
    d.style.top = Math.random() * 4800 + 'px';
    d.addEventListener('click', e => {
      e.stopPropagation();
      playRandomDecoy();
    });
    exhibitionSpace.appendChild(d);
  }

  function playRandomDecoy(){
    const src = decoyNoiseList[Math.floor(Math.random()*decoyNoiseList.length)];
    const a = new Audio(src);
    a.play().catch(()=>{});
  }

  function openExhibit(ex){
    if(currentAudio){ currentAudio.pause(); currentAudio = null; }
    exhibitTitle.textContent = ex.title;
    exhibitDescription.textContent = ex.description;
    exhibitTitle.dataset.id = ex.id;
    currentMode = 'artist';
    switchBtn.textContent = 'Куратор';
    playAudio(ex.audio_artist);
    exhibitPanel.classList.add('active');
    zoomTo(ex.x, ex.y, 2);
  }

  function playAudio(src){
    try{ if(currentAudio){ currentAudio.pause(); } }catch(e){}
    currentAudio = new Audio(src);
    currentAudio.volume = 1;
    currentAudio.play().catch(()=>{});
    playBtn.textContent = '❚❚';
    currentAudio.addEventListener('timeupdate', () => {
      if (!currentAudio || !currentAudio.duration || isNaN(currentAudio.duration)) return;
      audioProgress.value = (currentAudio.currentTime / currentAudio.duration) * 100;
    });
    currentAudio.addEventListener('ended', () => {
      playBtn.textContent = '▶';
      audioProgress.value = 0;
    });
  }

  switchBtn.addEventListener('click', () => {
    const id = exhibitTitle.dataset.id;
    if(!id) return;
    const ex = exhibits.find(e => String(e.id) === String(id));
    if(!ex) return;

    const newSrc = (currentMode === 'artist') ? ex.audio_curator : ex.audio_artist;
    const newMode = (currentMode === 'artist') ? 'curator' : 'artist';
    const oldA = currentAudio;
    const newA = new Audio(newSrc);
    newA.volume = 0;
    newA.play().catch(()=>{});
    let steps = 20;
    const step = 50;
    const fade = setInterval(()=>{
      if(oldA){ oldA.volume = Math.max(0, oldA.volume - 1/steps); }
      newA.volume = Math.min(1, newA.volume + 1/steps);
      steps--;
      if(steps <= 0){
        clearInterval(fade);
        if(oldA) try{ oldA.pause(); }catch(e){}
        currentAudio = newA;
      }
    }, step);

    currentMode = newMode;
    switchBtn.textContent = (currentMode === 'artist') ? 'Куратор' : 'Художник';
    playBtn.textContent = '❚❚';
    newA.addEventListener('timeupdate', () => {
      if(!newA.duration || isNaN(newA.duration)) return;
      audioProgress.value = (newA.currentTime / newA.duration) * 100;
    });
    newA.addEventListener('ended', () => {
      playBtn.textContent = '▶';
      audioProgress.value = 0;
    });
  });

  // Play/pause
  playBtn.addEventListener('click', () => {
    if(!currentAudio) return;
    if(currentAudio.paused) {
      currentAudio.play().catch(()=>{});
      playBtn.textContent = '❚❚';
    } else {
      currentAudio.pause();
      playBtn.textContent = '▶';
    }
  });

  // Перематывание по клику на прогресс-бар
  audioProgress.addEventListener('click', (e) => {
    if (!currentAudio || !currentAudio.duration || isNaN(currentAudio.duration)) return;
    const rect = audioProgress.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const ratio = x / rect.width;
    currentAudio.currentTime = currentAudio.duration * ratio;
    audioProgress.value = ratio * 100;
  });

  closeBtn.addEventListener('click', () => {
    exhibitPanel.classList.remove('active');
    if(currentAudio) try{ currentAudio.pause(); }catch(e){}
    playBtn.textContent = '▶';
    audioProgress.value = 0;
  });

  // Перетаскивание карты
  let dragStartX = 0, dragStartY = 0, mapX = -1000, mapY = -1000;

  function updateTransform() {
    exhibitionSpace.style.transform = `translate(${mapX}px, ${mapY}px) scale(${scale})`;
  }

  exhibitionSpace.addEventListener('mousedown', e => {
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
  });

  document.addEventListener('mousemove', e => {
    if (!isDragging) return;
    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    mapX += dx;
    mapY += dy;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    updateTransform();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
  });

  // Touch support
  let touchStartX = 0, touchStartY = 0;
  exhibitionSpace.addEventListener('touchstart', e => {
    if (e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isDragging = true;
    }
  });

  document.addEventListener('touchmove', e => {
    if (!isDragging || e.touches.length !== 1) return;
    const dx = e.touches[0].clientX - touchStartX;
    const dy = e.touches[0].clientY - touchStartY;
    mapX += dx;
    mapY += dy;
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    updateTransform();
  });

  document.addEventListener('touchend', () => {
    isDragging = false;
  });

  // Zoom
  function zoomTo(x, y, newScale) {
    scale = newScale;
    mapX = window.innerWidth / 2 - x * scale;
    mapY = window.innerHeight / 2 - y * scale;
    updateTransform();
  }

  zoomInBtn.addEventListener('click', () => {
    scale = Math.min(scale + 0.2, 3);
    updateTransform();
  });

  zoomOutBtn.addEventListener('click', () => {
    scale = Math.max(scale - 0.2, 0.5);
    updateTransform();
  });

  // Random noise on keypress
  document.addEventListener('keydown', (e) => {
    // Проверяем, что фокус не на панели экспоната
    if (exhibitPanel.classList.contains('active')) return;
    playRandomDecoy();
  });

  // Initial position
  updateTransform();

  // Вибрация при открытии экспоната (для Android)
  const originalOpenExhibit = openExhibit;
  openExhibit = function(ex) {
    if (typeof Android !== 'undefined') {
      Android.vibrate(15);
    } else if ('vibrate' in navigator) {
      navigator.vibrate(15);
    }
    originalOpenExhibit(ex);
  };
});

// PWA: Регистрация Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(registration => {
        console.log('✅ Service Worker зарегистрирован:', registration.scope);
      })
      .catch(error => {
        console.error('❌ Ошибка регистрации Service Worker:', error);
      });
  });
}
</script>
</body>
</html>
